<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tanks</title>
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .user-holder {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px;
    }

    .add-tank.disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .map {
      display: flex;
      flex-wrap: wrap;
    }

    .point {
      box-shadow: 0 0 0 1px #f1f1f1;
    }

    .point.bullet {
      background: #FF0000FF;
    }

    .point.active {
      position: relative;
      background: #435b2e;
      display: flex;
      align-items: center;
      box-shadow: 0 -34px 0 -15px #000;
    }

    .point.active:before, .point.active:after {
      content: '';
      position: absolute;
      width: 10px;
      height: calc(100% + 10px);
      left: -5px;
      background: #435b2e;
    }

    .point.active:after {
      left: auto;
      right: -5px;
    }

    .point.active.right {
      transform: rotate(90deg);
    }

    .point.active.left {
      transform: rotate(-90deg);
    }

    .point.active.down {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
<div class="user-holder">
  <input id="input" class="input-field" type="text" placeholder="Your Name">
  <button class="add-tank">Add</button>
</div>
<div class="map">
</div>
<script type="module">
  import {initializeApp} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, get, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const firebaseConfig = {
    apiKey: 'AIzaSyDORP4cvkKEC9PLokTIhFR-BahUnodJcbY',
    authDomain: 'tank-6847d.firebaseapp.com',
    databaseURL: 'https://tank-6847d-default-rtdb.asia-southeast1.firebasedatabase.app',
    projectId: 'tank-6847d',
    storageBucket: 'tank-6847d.firebasestorage.app',
    messagingSenderId: '320134240197',
    appId: '1:320134240197:web:e115db8268fbc3755b9dac'
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const arrRef = ref(db, 'points');


  document.querySelector('.add-tank').addEventListener('click', (evt) => {
    createTank(evt.currentTarget.previousElementSibling.value)
  });


  let id = ''
  let points = [];
  let mapSizeX = 13;
  let mapSizeY = 13;
  let pointSize = 50;
  const addButton = document.querySelector('.add-tank');

  function loadUser() {
    id = localStorage.getItem('tank-id');
  }

  function getPoints() {
    const listenForUpdates = () => {
      onValue(arrRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          console.log('Обновленные данные:', data);
          points = data;
          renderMap();
          moveBullets();
        } else {
          console.log('Данные не найдены');
        }
      }, (error) => {
        console.error('Ошибка при получении обновлений:', error);
      });
    };
    listenForUpdates();
  }

  function updatePoints() {
    const updateData = async (newData) => {
      try {
        await update(arrRef, newData); // Обновляем данные на Firebase
        console.log('Данные успешно обновлены');
      } catch (error) {
        console.error('Ошибка обновления данных:', error);
      }
    };
    updateData(points);
  }

  function createMap() {
    const mapElement = document.querySelector('.map');
    mapElement.style.width = `${mapSizeX * pointSize}px`;
    for (let i = 0; i < mapSizeX * mapSizeY; i++) {
      const pointElement = document.createElement('div');
      pointElement.classList.add('point');
      pointElement.style.width = `${pointSize}px`;
      pointElement.style.height = `${pointSize}px`;
      mapElement.appendChild(pointElement);
    }
  }

  function renderMap() {
    const pointsElements = document.querySelectorAll('.point');
    pointsElements.forEach((point, i) => {
      let dir = 'up';
      let active = false;
      let bullet = false;
      points.forEach((tank) => {
        if (tank.type === 'tank' && tank.p === i) {
          active = true;
          dir = tank.dir;
        }
        if (tank.type === 'bullet' && tank.p === i) {
          bullet = true;
          dir = tank.dir;
        }
      });
      point.classList.remove('right', 'left', 'up', 'down');
      point.classList.toggle(dir, active);
      point.classList.toggle('active', active);
      point.classList.toggle('bullet', bullet);
    });
  }

  function createTank(name) {
    id = name;
    localStorage.setItem('tank-id', id);
    let pos = Math.floor(Math.random() * (mapSizeX * mapSizeY - 1 + 1)) + 1;
    const tank = {p: pos, dir: 'up', type: 'tank', id: name};
    points.push(tank);
    updatePoints();
    addButton.blur();
  }

  function movePoint(points) {
    const filteredPoints = Array.isArray(points) ? points : [points];
    filteredPoints.forEach((point) => {
      let confines;
      if (point.dir === 'right') {
        confines = (point.p + mapSizeX) - (point.p % mapSizeX) - 1;
        if (point.type === 'bullet' && point.p === confines) {
          deleteBullet(point);
        }
        point.p = Math.min(point.p + 1, confines);
      } else if (point.dir === 'left') {
        confines = point.p - (point.p % mapSizeX);
        if (point.type === 'bullet' && point.p === confines) {
          deleteBullet(point);
        }
        point.p = Math.max(point.p - 1, confines);
      } else if (point.dir === 'up') {
        confines = (point.p % mapSizeX);
        if (point.type === 'bullet' && point.p === confines) {
          deleteBullet(point);
        }
        point.p = Math.max(point.p - mapSizeX, confines);
      } else if (point.dir === 'down') {
        confines = (mapSizeX * mapSizeY) - (mapSizeX - (point.p % mapSizeX));
        if (point.type === 'bullet' && point.p === confines) {
          deleteBullet(point);
        }
        point.p = Math.min(point.p + mapSizeX, confines);
      }
      handleBuilt(point);
    });
    renderMap();
  }

  function shoot() {
    let point = points.find((point) => point.id === id);
    const built = {p: point.p, dir: point.dir, type: 'bullet', interval: 0};
    points.push(built);
    updatePoints();
  }

  function moveBullets() {
    let bullets = points.filter((point) => point.type === 'bullet');
    bullets.forEach((bullet) => {
      bullet.interval = setInterval(() => {
        movePoint(bullet);
      }, 100);
    });
  }

  function handleBuilt(bullet) {
    if (bullet.type === 'bullet') {
      const index = points.findIndex((point) => point.id !== id && point.type === 'tank' && bullet.p === point.p);
      if (index !== -1) {
        points.splice(index, 1);
        deleteBullet(bullet);
        updatePoints();
        addButton.classList.toggle('disabled');
      }
    }
  }

  function deleteBullet(bullet) {
    const index = points.findIndex(p => p === bullet);
    if (index !== -1) {
      points.splice(index, 1);
      updatePoints();
    }
    clearInterval(bullet.interval);
  }

  addEventListener('keyup', (evt) => {
    let tank = points.find((point) => point.id === id);
    if (evt.keyCode === 39) {
      tank.dir = 'right';
      movePoint(tank);
    }
    if (evt.keyCode === 37) {
      tank.dir = 'left';
      movePoint(tank);
    }
    if (evt.keyCode === 38) {
      tank.dir = 'up';
      movePoint(tank);
    }
    if (evt.keyCode === 40) {
      tank.dir = 'down';
      movePoint(tank);
    }
    updatePoints();
    if (evt.keyCode === 32) {
      shoot();
    }
  });
  createMap();
  getPoints();
  loadUser();
</script>
</body>
</html>